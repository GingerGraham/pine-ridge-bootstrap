# Example Project Configuration for Sync Script Template
# Copy this file and customize it for your new Pine Ridge project

# Basic project identification (REQUIRED)
PROJECT_NAME="ExampleProject"                          # Human-readable name for logging
CONFIG_FILE="/etc/pine-ridge-example.conf"             # Path to systemd environment file
SSH_KEY_NAME="example_gitops_ed25519"                   # SSH key filename (without path)
LOCK_FILE="/var/run/example-sync.lock"                  # Lock file to prevent concurrent runs

# Repository validation function (REQUIRED)
# This code will be inserted into the sync script to validate repository structure
VALIDATION_CHECK='# Validate Example Project repository structure
    if [[ ! -f "required-config.yml" ]]; then
        error "Invalid repository structure: required-config.yml not found"
    fi

    if [[ ! -d "configs" ]]; then
        error "Invalid repository structure: configs directory not found"
    fi

    # Optional components - warn but do not fail
    if [[ ! -f "optional-file.yml" ]]; then
        log "Warning: optional-file.yml not found, some features may be unavailable"
    fi

    if [[ ! -d "optional-directory" ]]; then
        log "Warning: optional-directory not found, advanced features disabled"
    fi'

# Post-sync actions function (REQUIRED)
# Define functions that will be called after successful sync
POST_SYNC_ACTIONS='verify_example_config() {
    log "Verifying example project configuration..."

    cd "$INSTALL_DIR/repo"

    # Example: Check if configuration files are valid
    if [[ -f "required-config.yml" ]]; then
        log "Testing configuration file syntax..."
        
        # Example validation - replace with your project'\''s needs
        if command -v yq >/dev/null 2>&1; then
            if yq eval . required-config.yml >/dev/null 2>&1; then
                log "✓ Configuration file syntax is valid"
            else
                error "Configuration file syntax is invalid"
            fi
        else
            log "Warning: yq not available, skipping config validation"
        fi
    fi

    # Example: Test service connectivity or other project-specific checks
    log "✓ Example project configuration verified"
}

trigger_example_reload() {
    log "Triggering example project reload..."

    # Example: Reload a service if it exists
    if systemctl list-unit-files example-project.service >/dev/null 2>&1; then
        if systemctl is-active --quiet example-project.service 2>/dev/null; then
            log "Reloading example project service..."
            if systemctl reload example-project.service 2>/dev/null; then
                log "✓ Example project service reloaded successfully"
            else
                log "Warning: Failed to reload example project service"
                return 1
            fi
        else
            log "Example project service is not running, skipping reload"
        fi
    else
        log "Example project service not found, skipping reload"
    fi

    return 0
}

send_example_notification() {
    log "Sending example project notification..."
    
    # Example: Send notification about successful sync
    # This could be webhook, email, Slack, etc.
    
    local message="Example project synchronized successfully on branch $GIT_BRANCH"
    
    # Example webhook (customize for your needs)
    if [[ -n "${EXAMPLE_WEBHOOK_URL:-}" ]]; then
        if curl -s -X POST "$EXAMPLE_WEBHOOK_URL" -d "{\"message\": \"$message\"}" >/dev/null 2>&1; then
            log "✓ Notification sent successfully"
        else
            log "Warning: Failed to send notification"
        fi
    else
        log "No notification webhook configured, skipping"
    fi
}

# Main post-sync actions function - called when changes are detected
post_sync_actions() {
    verify_example_config
    
    if trigger_example_reload; then
        log "Reload completed successfully"
    else
        log "Warning: Reload failed - this will be retried on next sync"
    fi
    
    send_example_notification
}

# Post-sync verification function - called even when no changes are detected
# Use this for health checks that should run on every sync attempt
post_sync_verification() {
    verify_example_config
    
    # Example: Check service health
    if systemctl is-active --quiet example-project.service 2>/dev/null; then
        log "✓ Example project service is running"
    else
        log "Note: Example project service is not running"
    fi
}'

# Additional project-specific variables (OPTIONAL)
# You can define additional variables here that will be available in the generated script
# These should be documented in your project'\''s bootstrap documentation

# Example:
# EXAMPLE_TIMEOUT="30"
# EXAMPLE_RETRY_COUNT="3"
# LOG_LEVEL="INFO"

# Notes for this configuration:
#
# 1. All functions defined in POST_SYNC_ACTIONS will be available in the generated script
# 2. The post_sync_actions() function is called when changes are detected
# 3. The post_sync_verification() function is called on every run for health checks
# 4. Use single quotes for multi-line strings to avoid variable expansion issues
# 5. Escape any single quotes within the strings using '\''
# 6. Test your configuration thoroughly before deploying
#
# Required files in your project repository:
# - The files/directories you validate in VALIDATION_CHECK
# - Any files referenced in your post-sync actions
#
# Required system setup:
# - Any services referenced in your post-sync actions
# - Any commands/tools used in your validation or actions
# - Appropriate permissions for the actions your script performs
