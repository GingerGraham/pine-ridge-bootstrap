# Podman Project Configuration for Sync Script Template
# This file defines Podman-specific variables and functions for the sync script template

# Basic project identification
PROJECT_NAME="Podman"
CONFIG_FILE="/etc/pine-ridge-podman.conf"
SSH_KEY_NAME="podman_gitops_ed25519"
LOCK_FILE="/var/run/podman-sync.lock"

# Repository validation function
VALIDATION_CHECK='# Validate Podman repository structure
    if [[ ! -d "quadlets" ]]; then
        error "Invalid repository structure: quadlets directory not found"
    fi

    if [[ ! -d "ansible" ]]; then
        log "Warning: ansible directory not found, some automation may be unavailable"
    fi'

# Post-sync actions function  
POST_SYNC_ACTIONS='trigger_deployment() {
    log "Triggering quadlet deployment..."

    if systemctl is-active --quiet quadlet-deploy.service 2>/dev/null; then
        log "Deployment service is already running, skipping trigger"
        return 0
    fi

    # Check if deployment service exists
    if ! systemctl list-unit-files quadlet-deploy.service >/dev/null 2>&1; then
        log "Deployment service not found, skipping deployment trigger"
        return 0
    fi

    # Add better error handling for deployment trigger with timeout
    local deploy_timeout=30  # 30 seconds to start the service

    if timeout "$deploy_timeout" systemctl start quadlet-deploy.service 2>/dev/null; then
        log "Deployment triggered successfully"

        # Optional: Wait a bit to see if deployment starts properly
        sleep 2
        if systemctl is-active --quiet quadlet-deploy.service 2>/dev/null; then
            log "Deployment service is running"
        else
            log "Warning: Deployment service started but is no longer active"
        fi
    else
        local exit_code=$?
        if [[ $exit_code -eq 124 ]]; then
            log "Warning: Failed to trigger deployment service (timeout after ${deploy_timeout}s)"
        else
            log "Warning: Failed to trigger deployment service (exit code: $exit_code)"
        fi
        # Don'\''t exit here - this shouldn'\''t cause the sync to fail completely
        return 1
    fi
}

post_sync_actions() {
    if trigger_deployment; then
        log "Deployment trigger completed successfully"
    else
        log "Warning: Deployment trigger failed - this will be retried on next sync"
    fi
}

post_sync_verification() {
    # No verification needed for Podman currently
    log "Post-sync verification: No additional checks needed for Podman"
}'
