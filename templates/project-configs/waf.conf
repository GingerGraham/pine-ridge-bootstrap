# WAF Project Configuration for Sync Script Template
# This file defines WAF-specific variables and functions for the sync script template

# Basic project identification
PROJECT_NAME="WAF"
CONFIG_FILE="/etc/pine-ridge-waf.conf"
SSH_KEY_NAME="waf_gitops_ed25519"
LOCK_FILE="/var/run/waf-sync.lock"

# Repository validation function
VALIDATION_CHECK='# Validate WAF repository structure
    if [[ ! -f "site.yml" ]]; then
        error "Invalid repository structure: site.yml not found"
    fi

    if [[ ! -f "system-maintenance.yml" ]]; then
        log "Warning: system-maintenance.yml not found, system tasks will be skipped"
    fi'

# Post-sync actions function
POST_SYNC_ACTIONS='verify_vault_access() {
    log "Verifying vault password access..."

    cd "$INSTALL_DIR/repo"

    # Check if vault file exists
    if [[ -f "inventory/group_vars/vault.yml" ]]; then
        log "Testing vault password access..."

        # Test that the vault password script exists and is executable
        if [[ ! -x "/usr/local/bin/get-waf-vault-pass.sh" ]]; then
            error "Vault password script not found or not executable: /usr/local/bin/get-waf-vault-pass.sh"
        fi

        # Test that we can read the vault password
        if ! /usr/local/bin/get-waf-vault-pass.sh >/dev/null 2>&1; then
            error "Cannot read vault password. Check /etc/pine-ridge-waf-vault-pass exists and is readable"
        fi

        # Test that Ansible can decrypt the vault file
        if ! timeout 10 ansible-vault view inventory/group_vars/vault.yml >/dev/null 2>&1; then
            error "Cannot decrypt vault file. Check vault password is correct"
        fi

        log "âœ“ Vault access verified successfully"
    else
        log "No vault file found - skipping vault verification"
    fi
}

post_sync_actions() {
    verify_vault_access
}

post_sync_verification() {
    verify_vault_access
}'
